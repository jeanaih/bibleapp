<section class="page profile-page">
  <!-- Profile Header -->
  <div class="profile-card">
    <div class="profile-header-row">
      <div class="avatar-wrap" id="avatarWrap">
        <img id="profileAvatar" alt="Your photo" />
        <div class="avatar-fallback" id="avatarFallback">ðŸ‘¤</div>
        <input id="photoInput" type="file" accept="image/*" aria-label="Upload photo" />
      </div>

      <!-- Display Mode -->
      <div id="displayMode" class="display-mode">
        <div class="profile-info-display">
          <h2 id="displayName">Your Name</h2>
          <p id="displayBio">Add a bio...</p>
        </div>
        <button id="editBtn" class="edit-icon-btn" title="Edit Profile">
          <i class="bi bi-pencil-square"></i>
        </button>
      </div>
    </div>

    <!-- Edit Mode (Hidden) -->
    <div id="editMode" class="edit-mode" style="display: none;">
      <input type="text" id="nameInput" placeholder="Your name" class="input-field" />
      <textarea id="bioInput" placeholder="Add a bio..." rows="2" class="input-field" maxlength="20"></textarea>
      <div class="edit-actions">
        <button id="saveBtn" class="btn-primary">Save</button>
        <button id="cancelBtn" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Streak Section -->
  <div class="streak-card">
    <div class="streak-header">
      <div class="streak-icon">
        <i class="bi bi-fire"></i>
      </div>
      <div class="streak-info">
        <h3><span id="streakCount">0</span> Day Streak</h3>
        <p>Keep it going!</p>
      </div>
    </div>
    <div class="calendar-grid" id="calendarGrid">
      <!-- Calendar will be generated here -->
    </div>
  </div>

  <!-- Quick Links -->
  <div class="quick-links">
    <button class="link-card" id="notesLink">
      <div class="link-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-right: 12px;">
        <i class="bi bi-journal-text"></i>
      </div>
      <div class="link-info">
        <h4>My Notes</h4>
        <p id="notesCount">0 notes</p>
      </div>
      <i class="bi bi-chevron-right"></i>
    </button>

    <button class="link-card" id="savedLink">
      <div class="link-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); margin-right: 12px;">
        <i class="bi bi-bookmark-fill"></i>
      </div>
      <div class="link-info">
        <h4>Saved Verses</h4>
        <p id="savedCount">0 saved</p>
      </div>
      <i class="bi bi-chevron-right"></i>
    </button>
  </div>

  <!-- Settings -->
  <div class="settings-card">
    <h3 class="settings-title">Settings</h3>

    <div class="setting-item">
      <div class="setting-info">
        <i class="bi bi-moon-stars"></i>
        <span>Dark Mode</span>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="darkModeToggle">
        <span class="toggle-slider"></span>
      </label>
    </div>
  </div>
</section>

<style>
  .profile-page {
    padding: 16px 12px 100px;
    max-width: 600px;
    margin: 16px auto;
    background: #f8fafc;
    min-height: 100vh;
    transition: background-color 0.3s ease, color 0.3s ease;
    border-radius: 80px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }

  @media (min-width: 768px) {
    .profile-page {
      padding: 24px 20px 100px;
      max-width: 680px;
      border-radius: 100px;
    }

    .calendar-grid {
      justify-content: flex-start;
    }

    .cal-day {
      min-width: 60px;
      width: 60px;
      height: 60px;
    }

    .streak-card {
      padding: 32px;
    }

    .quick-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
  }

  /* Profile Card */
  .profile-card {
    background: #ffffff;
    border-radius: 100px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.03);
    transition: all 0.2s ease;
  }

  .profile-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
  }

  .profile-header-row {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 16px;
  }

  .avatar-wrap {
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .avatar-wrap:hover {
    transform: scale(1.05);
  }

  .avatar-wrap img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
  }

  .avatar-wrap img.active {
    display: block;
  }

  .avatar-fallback {
    font-size: 2.5rem;
    color: #d1d5db;
  }

  .avatar-wrap input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .avatar-overlay {
    position: absolute;
    bottom: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Display Mode */
  .display-mode {
    position: relative;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .profile-info-display {
    flex: 1;
    text-align: left;
  }

  .profile-info-display h2 {
    margin: 0 0 4px;
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
  }

  .profile-info-display p {
    margin: 0;
    font-size: 0.9rem;
    color: #6b7280;
    line-height: 1.4;
  }

  .edit-icon-btn {
    background: #f3f4f6;
    border: 0;
    border-radius: 10px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #6b7280;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .edit-icon-btn:hover {
    background: #e5e7eb;
    color: #667eea;
  }

  /* Edit Mode */
  .edit-mode {
    width: 100%;
  }

  .input-field {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 12px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    font-size: 1rem;
    font-family: inherit;
    margin-bottom: 12px;
    transition: all 0.2s ease;
  }

  .input-field:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  textarea.input-field {
    resize: vertical;
    min-height: 60px;
  }

  @media (max-width: 640px) {
    .input-field {
      font-size: 16px;
      /* Prevents zoom on iOS */
      padding: 14px;
    }

    textarea.input-field {
      min-height: 80px;
    }
  }

  .edit-actions {
    display: flex;
    gap: 12px;
  }

  .btn-primary,
  .btn-secondary {
    flex: 1;
    padding: 12px;
    border: 0;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: #667eea;
    color: #ffffff;
  }

  .btn-primary:hover {
    background: #5568d3;
  }

  .btn-secondary {
    background: #f3f4f6;
    color: #6b7280;
  }

  .btn-secondary:hover {
    background: #e5e7eb;
  }

  /* Streak Card */
  .streak-card {
    background: #ffffff;
    border-radius: 50px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.03);
    transition: all 0.2s ease;
  }

  .streak-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
  }

  .streak-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
  }

  .streak-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: #ffffff;
  }

  .streak-info h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
  }

  .streak-info p {
    margin: 4px 0 0;
    font-size: 0.85rem;
    color: #9ca3af;
  }

  /* Calendar Grid */
  .calendar-grid {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 8px;
  }

  .calendar-grid::-webkit-scrollbar {
    height: 4px;
  }

  .calendar-grid::-webkit-scrollbar-track {
    background: #f3f4f6;
    border-radius: 2px;
  }

  .calendar-grid::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 2px;
  }

  .cal-day {
    min-width: 50px;
    width: 50px;
    height: 50px;
    border-radius: 10px;
    background: #f3f4f6;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    transition: all 0.3s ease;
    flex-shrink: 0;
    scroll-snap-align: start;
    position: relative;
    overflow: hidden;
  }

  .cal-day::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 0%;
    background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%);
    transition: height 0.5s ease, box-shadow 0.3s ease;
    z-index: 0;
    box-shadow: inset 0 -2px 8px rgba(37, 99, 235, 0.3);
  }

  /* Water ripple effect on active days */
  .cal-day.active::before {
    animation: waterRipple 3s ease-in-out infinite;
  }

  @keyframes waterRipple {

    0%,
    100% {
      box-shadow: inset 0 -2px 8px rgba(37, 99, 235, 0.3);
    }

    50% {
      box-shadow: inset 0 -4px 12px rgba(59, 130, 246, 0.5);
    }
  }

  .cal-day-name,
  .cal-day>div:last-child {
    position: relative;
    z-index: 1;
  }

  .cal-day-name {
    font-size: 0.65rem;
    color: #b0b7c3;
    margin-bottom: 2px;
  }

  .cal-day.active {
    background: #f3f4f6;
    color: #ffffff;
    font-weight: 700;
  }

  .cal-day.active::before {
    height: 100%;
  }

  .cal-day.active .cal-day-name,
  .cal-day.active>div:last-child {
    color: #ffffff;
  }

  .cal-day[data-streak="1"]::before {
    height: 14%;
  }

  .cal-day[data-streak="2"]::before {
    height: 28%;
  }

  .cal-day[data-streak="3"]::before {
    height: 42%;
  }

  .cal-day[data-streak="4"]::before {
    height: 56%;
  }

  .cal-day[data-streak="5"]::before {
    height: 70%;
  }

  .cal-day[data-streak="6"]::before {
    height: 84%;
  }

  .cal-day.marked {
    position: relative;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
  }

  .streak-mark {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 12px;
    height: 12px;
    background: #10b981;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-weight: bold;
    animation: markPulse 2s ease-in-out infinite;
  }

  @keyframes markPulse {

    0%,
    100% {
      transform: scale(1);
      opacity: 0.8;
    }

    50% {
      transform: scale(1.1);
      opacity: 1;
    }
  }

  /* Enhanced wave effect for today */
  .cal-day.today::before {
    animation: enhancedWave 3s ease-in-out infinite;
    background: linear-gradient(180deg, #06b6d4 0%, #0891b2 50%, #0e7490 100%);
    box-shadow: inset 0 -3px 12px rgba(6, 182, 212, 0.4);
  }

  @keyframes enhancedWave {

    0%,
    100% {
      box-shadow: inset 0 -3px 12px rgba(6, 182, 212, 0.4);
      height: 100%;
    }

    50% {
      box-shadow: inset 0 -5px 18px rgba(6, 182, 212, 0.6);
      height: 100%;
    }
  }

  .cal-day[data-streak="2"] .cal-day-name,
  .cal-day[data-streak="2"]>div:last-child,
  .cal-day[data-streak="3"] .cal-day-name,
  .cal-day[data-streak="3"]>div:last-child,
  .cal-day[data-streak="4"] .cal-day-name,
  .cal-day[data-streak="4"]>div:last-child {
    color: #1e3a8a;
  }

  .cal-day[data-streak="5"] .cal-day-name,
  .cal-day[data-streak="5"]>div:last-child,
  .cal-day[data-streak="6"] .cal-day-name,
  .cal-day[data-streak="6"]>div:last-child,
  .cal-day[data-streak="7"] .cal-day-name,
  .cal-day[data-streak="7"]>div:last-child {
    color: #ffffff;
  }

  .cal-day.today {
    border: 2px solid #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
  }

  .cal-day.future {
    opacity: 0.5;
  }

  /* Quick Links */
  .quick-links {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .link-card {
    display: flex;
    align-items: center;
    background: #ffffff;
    border-radius: 100px;
    padding: 18px 20px;
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
    text-align: left;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
  }

  .link-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
    border-color: rgba(0, 0, 0, 0.08);
  }

  .link-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: #ffffff;
    flex-shrink: 0;
  }

  .link-info {
    flex: 1;
  }

  .link-info h4 {
    margin: 0 0 4px;
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
  }

  .link-info p {
    margin: 0;
    font-size: 0.85rem;
    color: #9ca3af;
  }

  .link-card>.bi-chevron-right {
    color: #d1d5db;
    font-size: 1.25rem;
  }

  /* Settings Card */
  .settings-card {
    background: #ffffff;
    border-radius: 50px;
    padding: 24px;
    margin-top: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.03);
    transition: all 0.2s ease;
  }

  .settings-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
  }

  .settings-title {
    margin: 0 0 20px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #1f2937;
  }

  .setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
    transition: background-color 0.2s ease;
    border-radius: 12px;
    padding: 16px;
  }

  .setting-item:hover {
    background-color: rgba(0, 0, 0, 0.01);
  }

  .setting-item:last-child {
    border-bottom: none;
  }

  .setting-info {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1rem;
    font-weight: 500;
    color: #1f2937;
  }

  .setting-info i {
    font-size: 1.25rem;
    color: #6b7280;
  }

  /* Toggle Switch */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #e5e7eb;
    transition: .4s;
    border-radius: 34px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked+.toggle-slider {
    background-color: #667eea;
  }

  input:checked+.toggle-slider:before {
    transform: translateX(22px);
  }

  /* Clear Cache Button */
  .btn-clear {
    background: #ef4444;
    color: white;
    border: 0;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-clear:hover {
    background: #dc2626;
  }

  /* === DARK MODE STYLES === */
  body.dark-mode .profile-page {
    background: #0f172a;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
  }

  /* Smooth scroll behavior */
  .profile-page {
    scroll-behavior: smooth;
  }

  /* Better spacing for mobile */
  @media (max-width: 480px) {
    .profile-page {
      padding: 12px 10px 80px;
    }
  }

  body.dark-mode .profile-card,
  body.dark-mode .streak-card,
  body.dark-mode .link-card,
  body.dark-mode .settings-card {
    background: #1f2937;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  body.dark-mode .profile-info-display h2,
  body.dark-mode .streak-info h3,
  body.dark-mode .link-info h4,
  body.dark-mode .settings-title,
  body.dark-mode .setting-info {
    color: #f9fafb;
  }

  body.dark-mode .profile-info-display p,
  body.dark-mode .streak-info p,
  body.dark-mode .link-info p {
    color: #9ca3af;
  }

  body.dark-mode .cal-day {
    background: #374151;
    color: #d1d5db;
  }

  body.dark-mode .cal-day-name {
    color: #6b7280;
  }

  /* Water effect in dark mode - lighter blue */
  body.dark-mode .cal-day::before {
    background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 50%, #1d4ed8 100%);
    box-shadow: inset 0 -2px 12px rgba(96, 165, 250, 0.4);
  }

  /* Water ripple effect on active days in dark mode */
  body.dark-mode .cal-day.active::before {
    animation: waterRippleDark 3s ease-in-out infinite;
  }

  @keyframes waterRippleDark {

    0%,
    100% {
      box-shadow: inset 0 -2px 12px rgba(96, 165, 250, 0.4);
    }

    50% {
      box-shadow: inset 0 -4px 16px rgba(96, 165, 250, 0.6);
    }
  }

  body.dark-mode .cal-day[data-streak="1"] .cal-day-name,
  body.dark-mode .cal-day[data-streak="1"]>div:last-child {
    color: #93c5fd;
  }

  body.dark-mode .cal-day[data-streak="2"] .cal-day-name,
  body.dark-mode .cal-day[data-streak="2"]>div:last-child,
  body.dark-mode .cal-day[data-streak="3"] .cal-day-name,
  body.dark-mode .cal-day[data-streak="3"]>div:last-child,
  body.dark-mode .cal-day[data-streak="4"] .cal-day-name,
  body.dark-mode .cal-day[data-streak="4"]>div:last-child {
    color: #dbeafe;
  }

  body.dark-mode .cal-day[data-streak="5"] .cal-day-name,
  body.dark-mode .cal-day[data-streak="5"]>div:last-child,
  body.dark-mode .cal-day[data-streak="6"] .cal-day-name,
  body.dark-mode .cal-day[data-streak="6"]>div:last-child,
  body.dark-mode .cal-day[data-streak="7"] .cal-day-name,
  body.dark-mode .cal-day[data-streak="7"]>div:last-child {
    color: #ffffff;
  }

  body.dark-mode .cal-day.today {
    border: 2px solid #60a5fa;
    box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
  }

  body.dark-mode .cal-day.active {
    background: #374151;
  }

  body.dark-mode .edit-icon-btn {
    background: #374151;
    color: #d1d5db;
  }

  body.dark-mode .edit-icon-btn:hover {
    background: #4b5563;
    color: #93c5fd;
  }

  body.dark-mode .input-field {
    background: #374151;
    border-color: #4b5563;
    color: #f9fafb;
  }

  body.dark-mode .input-field:focus {
    border-color: #60a5fa;
    box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
  }

  body.dark-mode .btn-secondary {
    background: #374151;
    color: #d1d5db;
  }

  body.dark-mode .btn-secondary:hover {
    background: #4b5563;
  }

  body.dark-mode .setting-item {
    border-bottom-color: #374151;
  }

  body.dark-mode .setting-info i {
    color: #9ca3af;
  }

  body.dark-mode .avatar-wrap {
    background: #374151;
  }

  body.dark-mode .calendar-grid::-webkit-scrollbar-track {
    background: #374151;
  }

  body.dark-mode .cal-day.marked {
    background: #4b5563;
    border: 1px solid #6b7280;
  }

  body.dark-mode .streak-mark {
    background: #34d399;
    color: #111827;
  }
</style>

<script>
  (function () {
    // Check if we have a name from welcome modal but no profile yet
    const welcomeName = localStorage.getItem('userName');
    const existingProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');

    // If we have a name from welcome but no profile name, update profile
    if (welcomeName && !existingProfile.name) {
      existingProfile.name = welcomeName;
      localStorage.setItem('userProfile', JSON.stringify(existingProfile));
    }

    const displayMode = document.getElementById('displayMode');
    const editMode = document.getElementById('editMode');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const displayName = document.getElementById('displayName');
    const displayBio = document.getElementById('displayBio');
    const nameInput = document.getElementById('nameInput');
    const bioInput = document.getElementById('bioInput');
    const photoInput = document.getElementById('photoInput');
    const avatarImg = document.getElementById('profileAvatar');
    const avatarFallback = document.getElementById('avatarFallback');

    // Load profile
    function loadProfile() {
      const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');

      // Check if we have a name from welcome modal but no profile name
      const welcomeName = localStorage.getItem('userName');
      if (welcomeName && !profile.name) {
        profile.name = welcomeName;
        localStorage.setItem('userProfile', JSON.stringify(profile));
      }

      document.getElementById('displayName').textContent = profile.name || 'Your Name';
      document.getElementById('displayBio').textContent = profile.bio || 'Add a bio...';

      // Set avatar if exists
      if (profile.photo) {
        document.getElementById('profileAvatar').src = profile.photo;
        document.getElementById('profileAvatar').classList.add('active');
        document.getElementById('avatarFallback').style.display = 'none';
      } else {
        document.getElementById('profileAvatar').classList.remove('active');
        document.getElementById('avatarFallback').style.display = 'flex';
      }
    }

    // Toggle edit mode
    editBtn.addEventListener('click', () => {
      const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
      nameInput.value = profile.name || '';
      bioInput.value = profile.bio || '';

      displayMode.style.display = 'none';
      editMode.style.display = 'block';
      nameInput.focus();
    });

    // Save profile
    saveBtn.addEventListener('click', () => {
      const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
      profile.name = nameInput.value.trim();
      let bio = bioInput.value.trim();
      if (bio.length > 10) {
        bio = bio.slice(0, 10);
        bioInput.value = bio;
        alert('Bio can only be up to 10 characters.');
      }
      profile.bio = bio;

      localStorage.setItem('userProfile', JSON.stringify(profile));
      loadProfile();

      displayMode.style.display = 'block';
      editMode.style.display = 'none';
    });

    // Cancel edit
    cancelBtn.addEventListener('click', () => {
      displayMode.style.display = 'block';
      editMode.style.display = 'none';
    });

    // Photo upload
    photoInput.addEventListener('change', async () => {
      const file = photoInput.files && photoInput.files[0];
      if (!file) return;

      if (file.size > 2 * 1024 * 1024) {
        alert('Image too large. Please use an image under 2MB.');
        return;
      }

      const photoData = await new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });

      const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
      profile.photo = photoData;
      localStorage.setItem('userProfile', JSON.stringify(profile));

      avatarImg.src = photoData;
      avatarImg.classList.add('active');
      avatarFallback.style.display = 'none';
    });

    // Track daily login
    function trackDailyLogin() {
      const today = new Date().toISOString().slice(0, 10);
      const streakHistory = JSON.parse(localStorage.getItem('streakHistory') || '{}');

      // Add today to streak history if not already there
      if (!streakHistory[today]) {
        streakHistory[today] = true;
        localStorage.setItem('streakHistory', JSON.stringify(streakHistory));
      }
    }

    // Generate calendar
    function generateCalendar() {
      const calendar = document.getElementById('calendarGrid');
      const today = new Date();
      const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];

      const streakHistory = JSON.parse(localStorage.getItem('streakHistory') || '{}');

      // Calculate consecutive streak count
      let consecutiveStreak = 0;
      const tempDate = new Date(today);

      // Check backwards for consecutive days
      while (consecutiveStreak < 7) {
        tempDate.setDate(tempDate.getDate() - consecutiveStreak);
        const checkStr = tempDate.toISOString().slice(0, 10);
        if (streakHistory[checkStr]) {
          consecutiveStreak++;
          tempDate.setTime(today.getTime()); // Reset
        } else {
          break;
        }
      }

      localStorage.setItem('streakCount', consecutiveStreak);
      document.getElementById('streakCount').textContent = consecutiveStreak;

      calendar.innerHTML = '';

      // Show 7 days before, today, and 7 days after (15 total)
      let dayStreakCount = 0;
      for (let i = -7; i <= 7; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() + i);
        const dateStr = date.toISOString().slice(0, 10);
        const dayName = dayNames[date.getDay()];

        // Count consecutive streak from past to present
        if (i <= 0 && streakHistory[dateStr]) {
          dayStreakCount++;
        } else if (i <= 0 && !streakHistory[dateStr]) {
          dayStreakCount = 0;
        }

        const dayEl = document.createElement('div');
        dayEl.className = 'cal-day';

        // Only show marks for past days with streak, fill only today
        if (streakHistory[dateStr]) {
          if (i === 0) {
            // Today: fill completely
            dayEl.classList.add('active', 'today');
            dayEl.setAttribute('data-streak', dayStreakCount);
          } else if (i < 0) {
            // Past days: show mark only
            dayEl.classList.add('marked');
          }
        }

        if (i > 0) dayEl.classList.add('future');

        dayEl.innerHTML = `
          <div class="cal-day-name">${dayName}</div>
          <div>${date.getDate()}</div>
          ${i < 0 && streakHistory[dateStr] ? '<div class="streak-mark">âœ“</div>' : ''}
        `;

        calendar.appendChild(dayEl);
      }
    }

    // Update counts
    function updateCounts() {
      const notes = JSON.parse(localStorage.getItem('notes') || '[]');
      const saved = JSON.parse(localStorage.getItem('savedVerses') || '[]');

      document.getElementById('notesCount').textContent = `${notes.length} note${notes.length !== 1 ? 's' : ''}`;
      document.getElementById('savedCount').textContent = `${saved.length} saved`;
    }

    // Navigation
    document.getElementById('notesLink').addEventListener('click', () => {
      localStorage.setItem('lastPage', 'notes.html');
      window.location.href = window.location.pathname + '?page=notes.html';
    });

    document.getElementById('savedLink').addEventListener('click', () => {
      localStorage.setItem('lastPage', 'saved.html');
      window.location.href = window.location.pathname + '?page=saved.html';
    });

    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    darkModeToggle.checked = isDarkMode;

    // Apply dark mode on load
    if (isDarkMode) {
      document.body.classList.add('dark-mode');
    }

    darkModeToggle.addEventListener('change', () => {
      const enabled = darkModeToggle.checked;
      localStorage.setItem('darkMode', enabled);

      // Apply to body
      if (enabled) {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    });

    loadProfile();
    trackDailyLogin(); // Track daily login first
    generateCalendar();
    updateCounts();
  })();
</script>